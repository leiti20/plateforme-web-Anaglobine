{% load static %}
{% load custom_tags %}

<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <title>Compte Patient</title>
  <link rel="stylesheet" href="{% static 'anaglobine/css/site.css' %}" media="screen">
  <link rel="stylesheet" href="{% static 'anaglobine/css/index.css' %}" media="screen">
  <script class="u-script" type="text/javascript" src="{% static 'anaglobine/js/jquery.js' %}" defer=""></script>
  <script class="u-script" type="text/javascript" src="{% static 'anaglobine/js/site.js' %}" defer=""></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{% static 'anaglobine/css/patient.css' %}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>

<body>

  {% include "anaglobine/includes/header.html" %}

  <!-- Contenu principal -->
  <div class="container text-center mt-4" style="flex: 1;">


    <!-- Icône Paramètres à gauche -->
    <div class="d-flex justify-content-between align-items-center mb-2 px-4">

      <!-- Icône personnalisée -->
      <button id="btnSettings" class="btn p-0 border-0 bg-transparent">
        <img src="{% static 'anaglobine/images/settings.png' %}" alt="Paramètres" height="35">
      </button>
      <form action="{% url 'logout' %}" method="post" style="display:inline;">
        {% csrf_token %}
        <button type="submit" style="background-color: #4A90E2;color: white;padding: 10px 20px;border: none;border-radius: 5px;cursor: pointer;font-weight: bold;transition: background-color 0.3s ease;
        margin-left: 20px;" onmouseover="this.style.backgroundColor='#adcce9'"
          onmouseout="this.style.backgroundColor='#adcce9'">
          Déconnexion
        </button>
      </form>

      <!-- Image de profil au centre -->
      <img src="{% static 'anaglobine/images/per.png' %}" class="rounded-circle mx-auto d-block" alt="Avatar"
        height="100">

    </div>

    <!-- Email en dessous -->
    <p class="fw-bold text-center"> {{ patient.email }}</p>

    <!-- Icônes -->
    <div class="d-flex justify-content-center gap-4 mb-4">
      <button class="btnInfos" id="btnInfos">
        <i class="fas fa-user"></i> Infomations personnelles
      </button>
      <button class="btnHistorique" id="btnHistorique">
        <i class="fas fa-history"></i> Historique
      </button>
      <button class="custom-btn-rdv" id="btnRdv" onclick="window.location.href='{% url 'rendezvous' %}'">
        <i class="fas fa-plus"></i> Prendre RDV
      </button>
    </div>

    <!-- Infos personnelles -->
    <div id="infosSection" class="slide-section">
      <div class="card p-3 mb-3">
        <h5>Informations personnelles</h5>
        <p><strong>Nom :</strong> {{ patient.nom }}</p>
        <p><strong>Prénom :</strong> {{ patient.prenom }}</p>
        <p><strong>Âge :</strong> {{ patient.age }}</p>
        <p><strong>Téléphone :</strong> {{ patient.telephone }}</p>
      </div>
    </div>
    <!-- Formulaire de modification -->
    <div id="modifSection" class="slide-section">
      <div class="card p-3 mb-3">
        <h5>Modifier les informations</h5>
        <form method="post">
          {% csrf_token %}
          <div class="mb-2">
            <label for="nom" class="form-label">Nom</label>
            <input type="text" name="nom" class="form-control" id="nom" value="{{ patient.nom }}">
          </div>
          <div class="mb-2">
            <label for="prenom" class="form-label">Prénom</label>
            <input type="text" name="prenom" class="form-control" id="prenom" value="{{ patient.prenom }}">
          </div>
          <div class="mb-2">
            <label for="age" class="form-label">Âge</label>
            <input type="number" name="age" class="form-control" id="age" value="{{ patient.age }}">
          </div>
          <div class="mb-2">
            <label for="telephone" class="form-label">Téléphone</label>
            <input type="text" name="telephone" class="form-control" id="telephone" value="{{ patient.telephone }}">
          </div>
          <button type="submit" class="btn btn-primary">Enregistrer</button>
        </form>
      </div>
    </div>
    <!-- Historique des rendez-vous -->
    <div id="historiqueSection" class="slide-section">
      <div class="card p-3">
        <h5>Historique des Rendez-vous</h5>
        {% if historique %}
        <ul class="list-group">
          {% for rdv in historique %}
          <li class="list-group-item">
            {{ rdv.creneau.date|date:"d F Y" }} à {{ rdv.creneau.heure_debut|time:"H:i" }}
            {{ rdv.type_analyse.nom }} chez {{ rdv.laboratoire.nom }}

            {% if resultats|dictkey:rdv.id %}
            {% with resultat=resultats|dictkey:rdv.id %}
            <br>
            <a href="data:application/pdf;base64,{{ resultat.get_fichier_pdf_base64 }}"
              download="resultat_{{ resultat.id }}.pdf">
              Télécharger le PDF
            </a>
            {% endwith %}
            {% else %}
            <span>Résultat non disponible.</span>
            {% endif %}
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p>Aucun rendez-vous enregistré pour le moment.</p>
        {% endif %}
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{% static 'anaglobine/js/patient.js' %}"></script>
  {% include "anaglobine/includes/footer.html" %}
</body>

</html>